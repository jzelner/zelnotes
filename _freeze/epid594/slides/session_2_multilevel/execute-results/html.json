{
  "hash": "3227f8c1d130ef92c30242aeb0de227b",
  "result": {
    "markdown": "---\npagetitle: \"Measuring spatial and contextual variation\"\n---\n## {{< meta pagetitle >}}\n\n<div class=\"paddeddiv\">\n  <p style=\"font-size:0.5em; text-align: left;\">\n      EPID 594  \n      Spatial Epidemiology  \n      University of Michigan School of Public Health\n      <br><br>\n      Jon Zelner  \n      `jzelner@umich.edu`  \n      [`epibayes.io`](https://epibayes.io) \n    </p>\n</div>\n\n![](/images/epid_logo.png){.absolute bottom=0 right=50 width=\"400\" height=\"100\"}\n\n\n\n## Today's <span class=\"alert\">Theme</span> {.imgslide} \n\n<img src=\"/images/radon_entry.png\">\n\nMaking the most of multi-level data using hierarchical models\n\n## Agenda\n\n- Brief recap of the threefold path of hierarchical modeling\n\n- Radon ‚ò¢Ô∏è lab üß™ ! \n\n- Preview of next week\n\n## Let's <span class=\"alert\">extend</span> the blood pressure model from Merlo et al. to include a <span class=\"alert\">risk/protective</span> factor.\n\n- Simulated study where we sample 1000 individuals ($i$) from 20 neighborhoods ($j$) and measure:\n\n- $y_{ij}$ is <span class=\"alert\">continuous</span> systolic blood pressure (SBP) for individual $i$ in location $j$.\n\n- $x_i \\in [0,1]$ is a binary exposure indicating whether the individual gets regular physical exercise.\n\n- $\\beta$ is an increase in $y_i$ associated with the exposure \n\n- $\\alpha$ is <span class=\"alert\">mean</span> SBP in the absence of exposure\n\n## How can we deal with the fact that people are <span class=\"alert\">clustered</span> within locations? \n\n<iframe src=\"https://giphy.com/embed/nz6qNPDA0dpsxbY0rl\" width=\"480\" height=\"304\" frameBorder=\"0\" class=\"giphy-embed\" allowFullScreen align=\"center\"></iframe>\n\nYou have <span class=\"alert\">three choices</span>: Which üö™ will you choose?\n\n## Door üö™ #1: Ignore clustering and fit a normal GLM\n\n- *Pool* data across all units, i.e. ignore clustering.\n\n- i.e. fit model $y_{ij} = \\alpha + \\beta x_i + \\epsilon_i$\n\n- Is this typically a good idea?\n\n## <span style=\"color:red\">NO!</span> {.imgslide}\n\n<img src=\"/images/regression_dragon_1.jpg\">\n\nComplete pooling ignores potential sources of *observed* and *unobserved* unit-level <span class=\"alert\">confounding</span>.\n\n\n## <span class=\"alert\">Full pooling</span> of clustered data violates assumption of independent errors\n\nA <span class=\"alert\"> fully pooled</span> model:\n\n$$\ny_i = \\alpha + \\beta x + \\epsilon_i\n$$\n\n:::{.fragment}\nAssumes $y_i$ is a combination of systematic variation ($\\alpha + \\beta x$) and *uncorrelated* random noise ($\\epsilon_i$) where:\n\n$$\n\\text{i.i.d.} \\epsilon \\sim Normal(0, \\sigma^2)\n$$\n:::\n## Your <span class=\"alert\">residuals</span> should look like this\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nrequire(ggplot2)\nset.seed(1299445)\ndf <- data.frame(x = rnorm(1000))\ng <- ggplot(df, aes(x = x)) +\n  geom_histogram(binwidth = 0.1, aes(y=..density..)) +\n  stat_function(fun = dnorm, args = list(mean = 0, sd = 1)) +\n  xlab(\"Distance from mean model prediction\") +\n  ylab(\"Density\") + \n  theme_bw()\nplot(g)\n```\n\n::: {.cell-output-display}\n![Residuals for a model with un-clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-1-1.png){width=960}\n:::\n:::\n\n\n## Your <span class=\"alert\">residuals</span> should look like this\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nrequire(ggplot2)\ng <- ggplot(df, aes(sample = x)) +\n  stat_qq() +\n  stat_qq_line()\n\nplot(g)\n```\n\n::: {.cell-output-display}\n![Residuals for a model with un-clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-2-1.png){width=960}\n:::\n:::\n\n\n## If you ignore <span class=\"alert\">strong</span> üí™ clustering (ICC = 0.9)\n\n\n::: {.cell}\n\n```{.r .cell-code  code-fold=\"true\"}\nrequire(ggplot2)\nicc <- 0.9\ntotal_var <- 1\ncluster_sigma <- sqrt(icc * total_var)\nind_sigma <- sqrt((1 - icc) * total_var)\nind_cluster <- 100\nncluster <- 10\ncluster_ids <- sort(rep(1:ncluster, ind_cluster))\ncluster_means <- rnorm(ncluster, sd = cluster_sigma)\nind_vals <- rnorm(n = length(cluster_ids), mean = cluster_means[cluster_ids], sd = ind_sigma)\n\ndf <- data.frame(x = ind_vals, cluster = cluster_ids)\n\ng <- ggplot(df, aes(x = x, cluster = cluster_ids)) +\n  geom_histogram(binwidth = 0.05, aes(y=..density..)) +\n  xlab(\"Distance from mean\") +\n  ylab(\"Density\") +\n  stat_function(fun = dnorm, args = list(mean = 0, sd = sqrt(total_var))) +\n  theme_bw()\n\n\nplot(g)\n```\n\n::: {.cell-output-display}\n![Clustered errors that are far from being normal](session_2_multilevel_files/figure-revealjs/unnamed-chunk-3-1.png){width=960}\n:::\n:::\n\n\n## If you ignore <span class=\"alert\">strong</span> üí™ clustering (ICC = 0.9)\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Qqplot of residuals](session_2_multilevel_files/figure-revealjs/unnamed-chunk-4-1.png){width=960}\n:::\n:::\n\n\n\n## If you ignore <span class=\"alert\">moderate</span> clustering (ICC = 0.5)\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Moderately clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-5-1.png){width=960}\n:::\n:::\n\n## If you ignore <span class=\"alert\">moderate</span> clustering (ICC = 0.5)\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Example of residuals for model with clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-6-1.png){width=960}\n:::\n:::\n\n\n\n## If you ignore <span class=\"alert\">weaker</span> clustering (ICC = 0.25)\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-7-1.png){width=960}\n:::\n:::\n\n\n## If you ignore <span class=\"alert\">weaker</span> clustering (ICC = 0.25)\n\n\n::: {.cell}\n::: {.cell-output-display}\n![Example of residuals for model with clustered errors](session_2_multilevel_files/figure-revealjs/unnamed-chunk-8-1.png){width=960}\n:::\n:::\n\n\n\n## Door üö™ #2: Fit a <span class=\"alert\">different model</span> to each cluster\n\n- <span class=\"alert\">Unpooled approach:</span>Fit a separate model to each unit ($j$), assuming outcomes in each unit are independent:\n\n- Model looks like: $y_{ij} = \\alpha_j + \\beta_j x_i + \\epsilon_{ij}$\n\n- Where: $\\epsilon_{ij} \\sim N(0, \\sigma_{j}^2)$\n\n## <span class=\"danger\">More danger!</span>\n\n<img src=\"/images/regression_dino.jpg\">\n\nTotally unpooled models run the risk of <span class=\"alert\">overfitting</span> the data, particularly in small samples.\n\n## Specific dangers of unpooled models\n\n- Some places may have few observations, making *unpooled* models impractical\n\n- We may want to allow the effect of an exposure to be consistent across location. \n\n- Will have nothing to say about data from a new location\n\n## How would our <span class=\"alert\">ideal</span> model split the difference between fully pooled and totally unpooled?\n\n- Encode the <span class=\"alert\">assumption</span> that places are similar unless data tell us otherwise.\n\n- Be <span class=\"alert\">flexible</span> enough to reflect information in new data without <span class=\"alert\">overfitting</span>.\n\n- Give answers equivalent to the <span class=\"alert\">fully pooled</span> and <span class=\"alert\">unpooled</span> approaches if that is what the data actually suggest.\n\n## Door üö™ #3: Partial Pooling üèä!\n\n- Allow <span class=\"alert\">effects</span> to vary across clusters, but constrain them to come from the same distribution:\n\n- Model looks like: $y_{ij} = \\alpha + \\beta x_i + \\epsilon_{i} + \\epsilon_{j}$\n\n- Where: $\\epsilon_{i} \\sim N(0, \\sigma_{i}^2)$\n\n- And: $\\epsilon_{j} \\sim N(0, \\sigma_{j}^2)$\n\n## What does partial pooling get us?\n\n- This approach accommodates variation across units without assuming they have *no* similarity.\n\n- Allows us to include covariates both about individuals and their spatial context.\n\n- More likely to make accurate <span class=\"alert\">out-of-sample</span> predictions than the fully-pooled or unpooled examples.\n\n# Radon!\n\n## Imagine you're in the <span class=\"alert\">radon system</span> business {.imgslide}\n\n<img src=\"/images/jz_radon.jpg\" style=\"width:25%\">\n\nMy very own radon mitigation system!\n\n## How could you use/extend the partial pooling model from the Gelman paper to:\n\n1. Sell more radon systems in Minnesota?\n\n2. Reduce the burden of inequality in radon-associated health risks in Minnesota?\n\n3. Branch out into other markets, like Michigan, where we have good measurements of soil uranium but don't have access to household-level radon measurements?\n\n\n::: {.cell}\n::: {.cell-output-display}\n```{=html}\n<div class=\"countdown\" id=\"timer_89b65c50\" data-warn-when=\"60\" data-update-every=\"1\" tabindex=\"0\" style=\"right:0;bottom:0;\">\n<div class=\"countdown-controls\"><button class=\"countdown-bump-down\">&minus;</button><button class=\"countdown-bump-up\">&plus;</button></div>\n<code class=\"countdown-time\"><span class=\"countdown-digits minutes\">05</span><span class=\"countdown-digits colon\">:</span><span class=\"countdown-digits seconds\">00</span></code>\n</div>\n```\n:::\n:::\n\n\n## As the soil uranium ‚ò¢Ô∏è increases, so does baseline county-level radon {.imgslide}\n\n<img src=\"/images/gelman_county_uranium.png\" style=\"width:70%\">\n\n## Counties with lots of soil uranium seem like a good bet for business {.imgslide}\n\n<img src=\"/images/radon_map.png\">\n\n## Partial pooling most benefits predictions for places with <span class=\"alert\">less data</span> {.imgslide}\n\n<img src=\"/images/gelman_basement_effect.png\" style=\"width:70%\">\n\nLight dotted line = full pooling; Light solid line = no pooling; Dark line = partial pooling \n\n## Time for a test-drive! üèéÔ∏è\n\n![](/images/radon_entry.png)\n\n[Radon hands-on activity](/posts/radon/index.qmd)\n\n## Next Week\n\n## References\n",
    "supporting": [
      "session_2_multilevel_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<link href=\"../../site_libs/countdown-0.4.0/countdown.css\" rel=\"stylesheet\" />\n<script src=\"../../site_libs/countdown-0.4.0/countdown.js\"></script>\n"
      ],
      "include-after-body": [
        "\n<script>\n  // htmlwidgets need to know to resize themselves when slides are shown/hidden.\n  // Fire the \"slideenter\" event (handled by htmlwidgets.js) when the current\n  // slide changes (different for each slide format).\n  (function () {\n    // dispatch for htmlwidgets\n    function fireSlideEnter() {\n      const event = window.document.createEvent(\"Event\");\n      event.initEvent(\"slideenter\", true, true);\n      window.document.dispatchEvent(event);\n    }\n\n    function fireSlideChanged(previousSlide, currentSlide) {\n      fireSlideEnter();\n\n      // dispatch for shiny\n      if (window.jQuery) {\n        if (previousSlide) {\n          window.jQuery(previousSlide).trigger(\"hidden\");\n        }\n        if (currentSlide) {\n          window.jQuery(currentSlide).trigger(\"shown\");\n        }\n      }\n    }\n\n    // hookup for slidy\n    if (window.w3c_slidy) {\n      window.w3c_slidy.add_observer(function (slide_num) {\n        // slide_num starts at position 1\n        fireSlideChanged(null, w3c_slidy.slides[slide_num - 1]);\n      });\n    }\n\n  })();\n</script>\n\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}